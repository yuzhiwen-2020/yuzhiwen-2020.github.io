---
title: é“¾è·¯è¿½è¸ª
date: 2023-10-19 09:00:00 +0800
categories: [jaeger,opentelemetry]
tags: [é“¾è·¯è¿½è¸ª, é€‰å‹]
author: elon
mermaid: true
---
# é“¾è·¯è¿½è¸ª(ä¸€)
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1ä¸‰ä¸ªæŒ‡æ ‡.png?w=10&h=14)
å¯è§‚æµ‹çš„ä¸‰å¤§æŒ‡æ ‡ï¼Œæˆ‘ä»¬ä¹‹å‰è°ƒç ”äº†logçš„EFKæ–¹æ¡ˆï¼ˆFluentdï¼‰ï¼Œæœ¬æ¬¡è°ƒç ”å®ç°traceï¼Œä¸šç•Œæœ‰å¾ˆå¤šæˆç†Ÿæ–¹æ¡ˆå¯é€‰æ‹©ï¼Œç»è¿‡å¯¹æ¯”å’Œè€ƒè™‘æœªæ¥metricçš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬é‡‡ç”¨opentelemetry+jagerçš„æ–¹å¼å®ç°

# ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ª
å¯ä»¥å°†ä¸€æ¬¡åˆ†å¸ƒå¼è¯·æ±‚è¿˜åŸæˆè°ƒç”¨é“¾è·¯ï¼Œå¹¶å°†è¯¥è¯·æ±‚çš„è°ƒç”¨æƒ…å†µé›†ä¸­å±•ç¤ºå‡ºæ¥ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒèƒ½å¤Ÿå±•ç¤ºå„ä¸ªæœåŠ¡èŠ‚ç‚¹ä¸Šçš„è€—æ—¶ã€è¯·æ±‚å…·ä½“åˆ°è¾¾å“ªå°æœºå™¨ä¸Šã€æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹çš„è¯·æ±‚çŠ¶æ€ç­‰ä¿¡æ¯ã€‚
å¦‚ä¸‹å›¾ï¼Œç”¨æˆ·è¯·æ±‚åˆ°äº†ä¸åŒæœåŠ¡çš„ä¸åŒæ¥å£ï¼Œæˆ‘ä»¬æƒ³çŸ¥é“æ•´ä¸ªè¯·æ±‚åˆ°è¾¾çš„serverï¼Œæ¯ä¸ªé˜¶æ®µå“åº”æ—¶é—´ç­‰ï¼Œå°±æ˜¯é“¾è·¯è¿½è¸ª
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ª.png?w=928&h=233)
# ä¸ºä»€ä¹ˆé“¾è·¯è¿½è¸ª
ä¸ºäº†è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éš¾ä»¥è¯Šæ–­çš„é—®é¢˜ã€‚é€šè¿‡åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼Œå¯ä»¥å°†è¯·æ±‚çš„è°ƒç”¨æƒ…å†µé›†ä¸­å±•ç¤ºå‡ºæ¥ï¼Œå¸®åŠ©å¼€å‘äººå‘˜å¿«é€Ÿå®šä½é”™è¯¯ä¿¡æ¯ï¼Œå¹¶æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ã€‚æ­¤å¤–ï¼Œåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªè¿˜å¯ä»¥æä¾›å„ä¸ªé˜¶æ®µé“¾è·¯è€—æ—¶ã€æœåŠ¡ä¾èµ–å…³ç³»ç­‰ä¿¡æ¯ï¼Œé€šè¿‡å¯è§†åŒ–ç•Œé¢å±•ç°å‡ºæ¥ï¼Œä½¿å¾—ç³»ç»Ÿæ€§èƒ½æ›´åŠ ç›´è§‚ï¼Œä¾¿äºåˆ†æå’Œä¼˜åŒ–ã€‚
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1ä¸ºä»€ä¹ˆé“¾è·¯è¿½è¸ª.png?w=973&h=285)
# ä¸šç•Œçš„æ–¹æ¡ˆ
## ç™¾èŠ±é½æ”¾
| |ä¸»è¦æ”¯æŒè¯­è¨€|å®ç°æ–¹å¼|æ¥å…¥æ–¹å¼|æ•°æ®å­˜å‚¨|é¢—ç²’åº¦|
|-|-|-|-|-|-|
|Zipkin|javaã€goã€phpç­‰|æ‹¦æˆªåå‘é€httpã€mq|åŸºäºlinkedï¼Œå¼•å…¥é…ç½®|esã€mysqlã€å†…å­˜ç­‰|æ¥å£çº§|
|Jaeger|javaã€goã€phpç­‰|æ‹¦æˆªè¯·æ±‚|æ‹¦æˆªã€ä¾µå…¥|esã€kafkaã€å†…å­˜ç­‰|æ¥å£çº§|
|Skywalking|javaã€goã€nodejsç­‰|javaæ¢é’ˆã€å­—èŠ‚ç |å­—èŠ‚ç ï¼Œæ— ä¾µå…¥|esã€h2ç­‰|æœåŠ¡æ–¹æ³•çº§|

æ³¨ï¼šä»¥ä¸Šçš„éƒ½æ”¯æŒOpenTracing
åœ¨è°ƒç ”çš„è¿‡ç¨‹å‘ç°ï¼Œç”±äºäº‘åŸç”Ÿã€å¾®æœåŠ¡çš„å‘å±•ï¼Œé€æ¸å‡ºç°é€šç”¨è§„èŒƒçš„OpenTracingã€å’ŒgoogleæŒ‡å®šçš„OpenSensus
## æ ‡å‡†å‡ºç°
### OpenTracing
https://opentracing.io/
é™¤ä»¥ä¸Šzipkinç­‰ï¼Œè¿˜æœ‰å…¶ä»–çš„é“¾è·¯è¿½è¸ªï¼Œå¦‚catã€Pinpointï¼ˆä¸å…¼å®¹opentracingï¼‰ï¼Œæ­£å› ä¸ºä¼—å¤šçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿé€šè¿‡ä½¿ç”¨ä¸å…¼å®¹ API çš„åº”ç”¨ç¨‹åºçº§æ£€æµ‹è¿›è¡Œå®ç°ï¼Œå¯¼è‡´å¼€å‘ä¸å…·æœ‰é€šç”¨æ€§ï¼Œæ‰è¯ç”Ÿäº† OpenTracing è§„èŒƒã€‚ä½äºåº”ç”¨ç¨‹åº/ç±»åº“å’Œè¿½è¸ªæˆ–æ—¥å¿—åˆ†æç¨‹åºä¹‹é—´çš„è½»é‡çº§æ ‡å‡†åŒ–å±‚
OpenTracingæ˜¯CNCFï¼ˆCloud Native Computing Foundation projectsï¼‰çš„é¡¹ç›®ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸å‚å•†æ— å…³çš„APIï¼Œå¹¶æä¾›äº†ä¸€ç§è§„èŒƒï¼Œå¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜è½»æ¾çš„åœ¨ä»–ä»¬çš„ä»£ç ä¸Šé›†æˆtracingã€‚å®˜æ–¹æä¾›äº†Go, JavaScript, Java, Python, Ruby, PHP, Objective-C, C++, C#ç­‰è¯­è¨€çš„æ”¯æŒã€‚å®ƒæ˜¯å¼€å‘çš„ä¸å±äºä»»ä½•ä¸€å®¶å…¬å¸ã€‚äº‹å®ä¸Šæœ‰å¾ˆå¤šå…¬å¸æ­£åœ¨æ”¯æŒOpenTracingï¼Œä¾‹å¦‚ï¼šZipkinå’ŒJaegeréƒ½éµå¾ªOpenTracingåè®®
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1opentracing.png?w=901&h=828)
### OpenCensus
https://opencensus.io/
OpenCensusæ˜¯Googleå¼€æºçš„ï¼Œä½œä¸ºæœ€æ—©æå‡ºTracingæ¦‚å¿µçš„å…¬å¸ï¼ŒOpenCensusä¹Ÿæ˜¯Google Dapperçš„ç¤¾åŒºç‰ˆæœ¬ï¼›OpenSensusæ˜¯å…è®¸ä½ é‡‡é›†åº”ç”¨ç¨‹åºMetricså’Œåˆ†å¸ƒå¼Tracesï¼Œå¹¶ä¸”æ”¯æŒå„ç§è¯­è¨€çš„åº“
é€šè¿‡agentç›´æ¥å‘é€é¥æµ‹æ•°æ®åˆ°æŒ‡å®šçš„exporterï¼ˆjaegerã€zipkinç­‰ï¼‰
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1opencensus.png?w=723&h=290)
é€šè¿‡å¼•å…¥openCensus collectorï¼Œåšä¸ºæ•°æ®ï¼ˆtraceã€metricsï¼‰ä¸­è½¬ï¼Œå®ç°ç¼“å†²ã€é‡è¯•åçš„æ¶æ„
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1ä¸‰åˆä¸€collector.png?w=898&h=685)

æ³¨ï¼šä»¥ä¸Šä¿©ç§æ¶æ„ä¹Ÿæ˜¯æˆ‘ä»¬åç»­ä»‹ç»çš„opentelemetryæ‰€å€Ÿé‰´çš„æ¶æ„ï¼Œå¯è§èªæ˜äººçš„æƒ³æ³•æ˜¯ç›¸åŒçš„ğŸ˜„
### æ€»ç»“
### æ€»ç»“
å¯ä»¥å¾ˆå®¹æ˜“åˆ†è¾¨å‡ºOpenTracingå’ŒOpenCensusçš„å·®åˆ«ï¼Œä¸»è¦åœ¨äºOpenCensusæŠŠMetricsåŒ…æ‹¬è¿›æ¥äº†ï¼Œä¸ä»…å¯ä»¥é‡‡é›†tracesï¼Œè¿˜æ”¯æŒé‡‡é›†metricsï¼Œè¿˜æœ‰ä¸€ç‚¹ä¸åŒOpenCensuså¹¶ä¸æ˜¯å•çº¯çš„è§„èŒƒåˆ¶å®šï¼Œä»–è¿˜æŠŠåŒ…æ‹¬æ•°æ®é‡‡é›†çš„Agentã€Collector
| |trace|metric|log|å®ç°|æ”¯æŒçš„é¡¹ç›®|
|-|-|-|-|-|-|
|OpenTracing|âœ…|â|â|åªæ˜¯å®šä¹‰è§„èŒƒ|jaegerã€skywalkingç­‰|
|OpenCensus|âœ…|âœ…|â|ä¸ä»…æœ‰è§„èŒƒï¼Œè¿˜æœ‰agentã€collectorå®ç°|è‡ªèº«çš„å¤šè¯­è¨€å®ç°|

# æˆ‘ä»¬éœ€è¦çš„
## æ€è€ƒ
ä»¥ä¸Šä»‹ç»ï¼Œæˆ‘ä»¬éœ€è¦å“ªä¸ªå‘¢ï¼Œè€ƒè™‘ä»¥ä¸‹é—®é¢˜
- åç»­æˆ‘ä»¬è¦è€ƒè™‘metricsçš„éªŒè¯å·¥ä½œ--openMetricsï¼Œè¿™å°±éœ€è¦ä¸‰ä¸ªä¸åŒçš„ç³»ç»Ÿæ¶æ„æ¥å®Œæˆå¯è§‚æµ‹ï¼›æ˜¯å¦æœ‰ä¸€ç§æ¶æ„å¯ä»¥æŠŠä¸‰å¤§æŒ‡æ ‡ï¼ˆlogã€traceã€metricsï¼‰éƒ½ç»Ÿä¸€å‘¢ï¼Ÿ
- å¦‚æœå¯è§‚æµ‹å¼•å…¥ä¸‰å¥—ç³»ç»Ÿï¼Œåœ¨ç¨³å®šã€å¯ç»´æŠ¤æ€§éƒ½å¸¦æ¥å·¥ä½œé‡ï¼Œæ˜¯å¦æœ‰ç»Ÿä¸€çš„æ¶æ„å‘¢ï¼Ÿ
- æ˜¯å¦æœ‰åœ¨è·¨è¯­è¨€æ¶æ„ä¸Šä¼˜ç§€çš„ç”Ÿæ€ï¼Ÿ
- å¦‚æœç»‘å®šåˆ°æŸä¸ªè§£å†³æ–¹æ¡ˆçš„å‚å®¶ï¼Œä¸åˆ©äºåç»­çš„æ‰©å±•ã€ç»´æŠ¤ã€è°ƒæ•´ã€ä¼˜åŒ–ï¼Œå› æ­¤æœ‰æ²¡æœ‰ä¸å‚å®¶æ— å…³çš„è§£å†³æ–¹æ¡ˆï¼Ÿ
## ä¸»è§’å‡ºç°ï¼š
OpenCensusä¸OpenTracingä¸ºäº†å°†ä¸¤è€…çš„ä¼˜ç‚¹è¿›è¡Œæ•´åˆï¼Œå®£å¸ƒå°†è¿›è¡Œåˆå¹¶ï¼Œä¸¤è€…çš„åˆå¹¶å°±æ˜¯åæ¥èµ«èµ«æœ‰åï¼šOpenTelemetry ï¼›OpenTelemetryä¸å‚å•†ã€å¹³å°æ— å…³ï¼Œä¸æä¾›ä¸å¯è§‚æµ‹æ€§ç›¸å…³çš„åç«¯æœåŠ¡ã€‚å¯æ ¹æ®ç”¨æˆ·éœ€æ±‚å°†å¯è§‚æµ‹ç±»æ•°æ®å¯¼å‡ºåˆ°å­˜å‚¨ã€æŸ¥è¯¢ã€å¯è§†åŒ–ç­‰ä¸åŒåç«¯ï¼Œå¦‚ Prometheusã€Jaeger ã€äº‘å‚å•†æœåŠ¡ä¸­ã€‚è¯¥é¡¹ç›®å¾—åˆ°äº†äº‘æä¾›å•†ã€å‚å•†å’Œæœ€ç»ˆç”¨æˆ·çš„å¹¿æ³›è¡Œä¸šæ”¯æŒå’Œé‡‡ç”¨ï¼›
æ³¨ï¼šhttps://github.com/open-telemetry/opentelemetry-goæ˜¯goè¯­è¨€çš„opentelemetryå®ç°ï¼Œç›®å‰goçš„metricsåˆ°äº†è´å¡”ç‰ˆæœ¬ï¼Œlogè¿˜æ²¡æœ‰å¼€å‘å®Œæˆï¼Œä¸è¿‡traceæ˜¯æ¯”è¾ƒæˆç†Ÿçš„äº†
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1ä¸‰åˆä¸€.png?w=834&h=542)
|æ ‡å‡†|æ¦‚è¿°|traces| metrics|logs|çŠ¶æ€|
|-|-|-|-|-|-|
|OpenTracing|CNCFé¡¹ç›®-2015å¹´|âœ…| | |åœæ­¢æ›´æ–°|
|OpenCensus|èµ·æºGoogle-2017å¹´|âœ…|âœ…| |åœæ­¢æ›´æ–°|
|OpenMetrics|èµ·æºPrometheusç¤¾åŒº-2017å¹´| |âœ…| |æŒç»­æ›´æ–°|
|OpenTelemetry|OpenTracingã€OpenCensusåˆå¹¶-2019å¹´|âœ…|âœ…|âœ…|è“¬å‹ƒå‘å±•|

![å›¾ç‰‡](/assets/imgs/k8s/traceing/1collectoråˆä¸€.png?w=516&h=536)
# Opentelemetry
æ”¯æŒ11ç§ä¸»æµè¯­è¨€ï¼ˆc++ã€.netã€erlangã€goã€javaã€jsã€phpã€pyã€rubyã€rustã€swiftï¼‰ï¼›OpenTelemetryä¸æ˜¯åƒJaegerã€Skywalkingã€Prometheusè¿™æ¡†æ¶å…·å¤‡å­˜å‚¨ï¼ŒæŸ¥è¯¢ï¼Œdashboardçš„æœåŠ¡ã€‚ç›¸åï¼Œå®ƒæ”¯æŒå°†æ•°æ®å¯¼å‡ºåˆ°å„ç§å¼€æºå’Œå•†ä¸šåç«¯ã€‚å®ƒæä¾›äº†ä¸€ä¸ªå¯æ’æ‹”çš„ä½“ç³»ç»“æ„ï¼Œå› æ­¤å¯ä»¥è½»æ¾æ·»åŠ é™„åŠ çš„æŠ€æœ¯åè®®å’Œæ ¼å¼

å› ä¸ºéœ€è¦è¿½è¸ªè·¨è¯­è¨€çš„äº’æ“ä½œæ€§ã€‚è®¸å¤šè¯­è¨€éƒ½å¸¦æœ‰ç±»å‹å®šä¹‰ï¼Œå¯ä»¥åœ¨å®ç°ä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚ç”¨äºåˆ›å»ºå¯é‡ç”¨ç»„ä»¶çš„æ¥å£ã€‚åŒ…æ‹¬å¯è§‚æµ‹å®¢æˆ·ç«¯å†…éƒ¨å®ç°æ‰€éœ€è¦çš„è§„èŒƒï¼Œä»¥åŠå¯è§‚æµ‹å®¢æˆ·ç«¯ä¸å¤–éƒ¨é€šä¿¡æ‰€éœ€å®ç°çš„åè®®è§„èŒƒã€‚å…·ä½“åŒ…æ‹¬ï¼š
- APIï¼šå®šä¹‰ Metricsã€Tracingã€Logs æ•°æ®çš„ç±»å‹å’Œæ“ä½œã€‚
- SDKï¼šå®šä¹‰ API ç‰¹å®šè¯­è¨€å®ç°éœ€æ±‚ï¼Œå®šä¹‰é…ç½®ã€æ•°æ®å¤„ç†å’Œå¯¼å‡ºæ¦‚å¿µã€‚
- æ•°æ®ï¼šå®šä¹‰ OpenTelemetry Line Protocol ï¼ˆOTLPï¼‰ã€‚è™½ç„¶åœ¨ Opentelemetryä¸­ç»„ä»¶æ”¯æŒäº† Zipkin v2 æˆ– Jaeger Thrift åè®®æ ¼å¼çš„å®ç°ï¼Œä½†éƒ½ä»¥ç¬¬ä¸‰æ–¹è´¡çŒ®åº“å½¢å¼æä¾›ã€‚åªæœ‰ OTLP æ˜¯ Opentelemetry å®˜æ–¹åŸç”Ÿæ”¯æŒçš„æ ¼å¼ã€‚
## æ¦‚å¿µ
Otel : å°±æ˜¯otelemetry
Otlp : å¯¼å‡ºé¥æµ‹æ•°æ®çš„åè®®
Otel Collector :æœé›†otelçš„sdkæˆ–è€…apiå‘é€çš„æ•°æ®ï¼Œåœ¨è½¬å‘åˆ°æŒ‡å®šç›®æ ‡ç«¯
```lua
                                          -----> Jaeger (trace)
App + SDK ---> OpenTelemtry Collector ---|
                                          -----> Prometheus (metrics)
```
traceid :æŸæ¬¡è¯·æ±‚çš„è¯·æ±‚idï¼Œç”¨æ¥ä¸²è”è¯·æ±‚çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œç›´åˆ°è¯·æ±‚è¿”å›
spanid :åœ¨æŸä¸ªè¯·æ±‚é˜¶æ®µï¼Œå‡ºç°åœ¨æŸä¸ªæœåŠ¡çš„æŸä¸ªæ¥å£å†…éƒ¨ï¼Œä¹Ÿå³æŸæ¬¡è¯·æ±‚ç§çš„ä¸€ä¸ªç‰‡æ®µï¼Œè¿™ä¸ªç‰‡æ®µä¹Ÿå«span
traceï¼šé€šè¿‡traceidä¸²è”èµ·æ¥çš„è¯·æ±‚è·¯å¾„ï¼Œå°±æ˜¯ä¸€æ¬¡traceï¼ŒæŸä¸ªspanæ˜¯ä¸€æ¬¡ç¬‘çš„traceï¼Œå¤šä¸ªtracesç»„æˆä¸€ä¸ªtrace
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1spanæ¦‚å¿µ.png?w=1059&h=425)
opentelemetry-collector ï¼šæ ¸å¿ƒä»“åº“ï¼Œç”¨äºæ•´åˆå¯è§‚æµ‹æ€§æŒ‡æ ‡
opentelemetry-collector-contrib ï¼šä¸ºç¬¬ä¸‰æ–¹æä¾›çš„ç»Ÿä¸€æ ‡å‡†ï¼Œç¬¬ä¸‰æ–¹å®ç°collectorçš„æ ¸å¿ƒä»“åº“
opentelemetry-xxxï¼ˆé»„è‰²ï¼‰:å…·ä½“è¯­è¨€çš„å®ç°
opentelemetry-xxx-instrumentationï¼ˆç»¿è‰²ï¼‰ :å…·ä½“è¯­è¨€çš„otelæƒ…å†µï¼Œå®ç°ä¸€ä½“åŒ–ã€å¼€ç®±å³ç”¨çš„ç¬¬ä¸‰æ–¹otelï¼Œå¦‚grpcçš„æ¥å…¥
opentelemetry-xxx-contrib ï¼ˆç´«è‰²ï¼‰:ä¸ºç¬¬ä¸‰æ–¹çš„ä¸€äº›åº“æä¾›ä¾¿æ·çš„æ–¹å¼æ¥å…¥otleåº“ï¼›å¦‚é’ˆå¯¹beegoã€gin
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1projects.png?w=1127&h=422)
## OpenTelemetry æ”¯æŒçš„æ•°æ®ç±»å‹

- Metrics
Metric æ˜¯å…³äºä¸€ä¸ªæœåŠ¡çš„åº¦é‡ï¼Œåœ¨è¿è¡Œæ—¶æ•è·ã€‚ä»é€»è¾‘ä¸Šè®²ï¼Œæ•è·å…¶ä¸­ä¸€ä¸ªé‡åº¦çš„æ—¶åˆ»ç§°ä¸º Metric eventï¼Œå®ƒä¸ä»…åŒ…å«é‡åº¦æœ¬èº«ï¼Œè¿˜åŒ…æ‹¬è·å–å®ƒçš„æ—¶é—´å’Œç›¸å…³å…ƒæ•°æ®ã€‚åº”ç”¨å’Œè¯·æ±‚æŒ‡æ ‡æ˜¯å¯ç”¨æ€§å’Œæ€§èƒ½çš„é‡è¦æŒ‡æ ‡ã€‚è‡ªå®šä¹‰æŒ‡æ ‡å¯ä»¥æ·±å…¥äº†è§£å¯ç”¨æ€§å¦‚ä½•å½±å“ç”¨æˆ·ä½“éªŒå’Œä¸šåŠ¡ã€‚è‡ªå®šä¹‰ Metrics å¯ä»¥æ·±å…¥ç†è§£å¯ç”¨æ€§ Metrics æ˜¯å¦‚ä½•å½±å“ç”¨æˆ·ä½“éªŒæˆ–ä¸šåŠ¡çš„ã€‚OpenTelemetry ç›®å‰å®šä¹‰äº†ä¸‰ä¸ª Metric å·¥å…·ï¼š
1. counter: ä¸€ä¸ªéšæ—¶é—´æ±‚å’Œçš„å€¼ï¼Œå¯ä»¥ç†è§£æˆæ±½è½¦çš„é‡Œç¨‹è¡¨ï¼Œå®ƒåªä¼šä¸Šå‡ã€‚
2. measure: éšæ—¶é—´èšåˆçš„å€¼ã€‚å®ƒè¡¨ç¤ºæŸä¸ªå®šä¹‰èŒƒå›´å†…çš„å€¼ã€‚
3. observer: æ•æ‰ç‰¹å®šæ—¶é—´ç‚¹çš„ä¸€ç»„å½“å‰å€¼ï¼Œå¦‚è½¦è¾†ä¸­çš„ç‡ƒæ²¹è¡¨ã€‚

- Logs
æ—¥å¿—æ˜¯å¸¦æœ‰æ—¶é—´æˆ³çš„æ–‡æœ¬è®°å½•ï¼Œå¯ä»¥æ˜¯å¸¦æœ‰å…ƒæ•°æ®ç»“æ„åŒ–çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯éç»“æ„åŒ–çš„ã€‚è™½ç„¶æ¯ä¸ªæ—¥å¿—éƒ½æ˜¯ç‹¬ç«‹æ•°æ®æºï¼Œä½†å¯ä»¥é™„åŠ åˆ° Trace çš„ Span ä¸­ã€‚æ—¥å¸¸ä½¿ç”¨è°ƒç”¨æ—¶ï¼Œåœ¨è¿›è¡ŒèŠ‚ç‚¹åˆ†ææ—¶å‡ºä¼´éšç€ä¹Ÿå¯çœ‹åˆ°æ—¥å¿—ã€‚
åœ¨ OpenTelemetry ä¸­ï¼Œä»»ä½•ä¸å±äºåˆ†å¸ƒå¼ Trace æˆ– Metrics çš„æ•°æ®éƒ½æ˜¯æ—¥å¿—ã€‚æ—¥å¿—é€šå¸¸ç”¨äºç¡®å®šé—®é¢˜æ ¹å› ï¼Œé€šå¸¸åŒ…å«æœ‰å…³è°æ›´æ”¹äº†å†…å®¹ä»¥åŠæ›´æ”¹ç»“æœçš„ä¿¡æ¯ã€‚

- Traces
Trace æŒ‡å•ä¸ªè¯·æ±‚çš„è¿½è¸ªï¼Œè¯·æ±‚å¯ä»¥ç”±åº”ç”¨ç¨‹åºå‘èµ·ï¼Œä¹Ÿå¯ä»¥ç”±ç”¨æˆ·å‘èµ·ã€‚åˆ†å¸ƒå¼ Tracing æ˜¯è·¨ç½‘ç»œï¼Œè·¨åº”ç”¨çš„è¿½è¸ªå½¢å¼ã€‚æ¯ä¸ªå·¥ä½œå•å…ƒåœ¨ Trace ä¸­è¢«ç§°ä¸º Spanï¼Œä¸€ä¸ª Trace ç”±ä¸€ä¸ªæ ‘å½¢çš„ Span ç»„æˆã€‚Span è¡¨ç¤ºç»è¿‡åº”ç”¨ç¨‹åºæ‰€è®¾è®¡çš„æœåŠ¡æˆ–ç»„ä»¶æ‰€åšå·¥ä½œçš„å¯¹è±¡ï¼ŒSpan è¿˜æä¾›äº†å¯ç”¨äºè°ƒè¯•å¯ç”¨æ€§å’Œæ€§èƒ½é—®é¢˜çš„è¯·æ±‚ã€é”™è¯¯å’ŒæŒç»­æ—¶é—´çš„ Metricsã€‚Span åŒ…å«äº†ä¸€ä¸ª Span ä¸Šä¸‹æ–‡ï¼Œå®ƒæ˜¯ä¸€ç»„å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè¡¨ç¤ºæ¯ä¸ª Span æ‰€å±çš„å”¯ä¸€è¯·æ±‚ã€‚é€šå¸¸æˆ‘ä»¬ç§°ä¹‹ä¸º TraceIDã€‚
- Baggage
é™¤äº† Trace çš„ä¼ æ’­ï¼ŒOpenTelemetry è¿˜æä¾›äº† Baggage æ¥ä¼ æ’­é”®å€¼å¯¹ã€‚Baggage ç”¨äºç´¢å¼•ä¸€ä¸ªæœåŠ¡ä¸­çš„å¯è§‚å¯Ÿäº‹ä»¶ï¼Œè¯¥æœåŠ¡åŒ…å«åŒä¸€äº‹åŠ¡ä¸­å…ˆå‰çš„æœåŠ¡æä¾›çš„å±æ€§ï¼Œæœ‰åŠ©äºåœ¨äº‹ä»¶ä¹‹é—´å»ºç«‹å› æœå…³ç³»ã€‚è™½ç„¶ Baggage å¯ä»¥ç”¨ä½œå…¶ä»–æ¨ªåˆ‡å…³æ³¨ç‚¹çš„åŸå‹ï¼Œä½†è¿™ç§æœºåˆ¶ä¸»è¦æ˜¯ä¸ºäº†ä¼ é€’ OpenTelemetry å¯è§‚æµ‹æ€§ç³»ç»Ÿçš„å€¼ã€‚è¿™äº›å€¼å¯ä»¥ä» Baggage ä¸­æ¶ˆè´¹ï¼Œå¹¶ä½œä¸ºåº¦é‡çš„é™„åŠ ç»´åº¦ï¼Œæˆ–æ—¥å¿—å’Œè·Ÿè¸ªçš„é™„åŠ ä¸Šä¸‹æ–‡ä½¿ç”¨ã€‚
## OpenTelemetryæ¶æ„
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1æ¶æ„.png?w=905&h=581)
### Otel API
- Tracer API
Tracer API æ”¯æŒç”Ÿæˆspansï¼Œå¯ä»¥ç»™spanåˆ†é…ä¸€ä¸ªtraceIdï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æ€§åœ°åŠ ä¸Šæ—¶é—´æˆ³ã€‚ä¸€ä¸ªTracerä¼šç»™spansæ‰“ä¸Šåç§°å’Œç‰ˆæœ¬ã€‚å½“æŸ¥çœ‹æ•°æ®æ—¶ï¼Œåç§°å’Œç‰ˆæœ¬ä¼šä¸ä¸€ä¸ªTracerå…³è”ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥è¿½è¸ªç”Ÿæˆsapançš„æ’è£…åº“ã€‚
- Metric API
Metric APIæä¾›äº†å¤šç§ç±»å‹çš„Metric instruments(æ¡©åŠŸèƒ½)ï¼Œå¦‚CountersÂ å’ŒObserversã€‚Counters å…è®¸å¯¹åº¦é‡è¿›è¡Œè®¡ç®—ï¼ŒObserverså…è®¸è·å–ç¦»æ•£æ—¶é—´ç‚¹ä¸Šçš„æµ‹é‡å€¼ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨Observers è§‚å¯Ÿä¸åœ¨Spanä¸Šä¸‹æ–‡ä¸­å‡ºç°çš„æ•°å€¼ï¼Œå¦‚å½“å‰CPUè´Ÿè½½æˆ–ç£ç›˜ä¸Šç©ºé—²çš„å­—èŠ‚æ•°ã€‚
- Context API
Context APIÂ ä¼šåœ¨ä½¿ç”¨ç›¸åŒ"context"çš„spanså’Œtracesä¸­æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¦‚W3C Trace Context,Â Zipkin B3é¦–éƒ¨, æˆ–Â New Relic distributed tracingÂ é¦–éƒ¨ã€‚æ­¤å¤–è¯¥APIå…è®¸è·Ÿè¸ªspansæ˜¯å¦‚ä½•åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ä¼ é€’çš„ã€‚å½“ä¸€ä¸ªtraceä»ä¸€ä¸ªå¤„ç†ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªå¤„ç†æ—¶ä¼šæ›´æ–°ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚Metric instrumentså¯ä»¥è®¿é—®å½“å‰ä¸Šä¸‹æ–‡ã€‚
### Otel SDK
OpenTelemetry SDKæ˜¯OpenTelemetry APIçš„å®ç°ã€‚è¯¥SDKåŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼Œä¸ä¸Šé¢çš„APIç±»ä¼¼ï¼šTracer, ä¸€ä¸ªMeter, å’Œä¸€ä¸ªshared Context layer
ä»¥ä¸‹ä¸ºä¸€ä¸ªsdkçš„ä½¿ç”¨ä¾‹å­ï¼Œå¯åœ¨githubä¸Šæ‰¾åˆ°
```go
func tracerProvider(url string) (*tracesdk.TracerProvider, error) {
	// Create the Jaeger exporter
	exp, err := jaeger.New(jaeger.WithCollectorEndpoint(jaeger.WithEndpoint(url)))
	if err != nil {
		return nil, err
	}
	tp := tracesdk.NewTracerProvider(
		// Always be sure to batch in production.
		tracesdk.WithBatcher(exp),
		// Record information about this application in a Resource.
		tracesdk.WithResource(resource.NewWithAttributes(
			semconv.SchemaURL,
			semconv.ServiceNameKey.String(service),
			attribute.String("environment", environment),
			attribute.Int64("ID", id),
		)),
	)
	return tp, nil
}
```
### Otel Collector 
OpenTelemetry Collectoræä¾›äº†ä¸€ç§å‚å•†ä¸­ç«‹çš„å®ç°ï¼Œæ— ç¼åœ°æ¥æ”¶ï¼Œå¤„ç†å’Œå¯¼å‡ºé¥æµ‹æ•°æ®ã€‚æ­¤å¤–ï¼Œå®ƒç§»é™¤äº†ä¸ºæ”¯æŒå‘é€åˆ°å¤šä¸ªå¼€æºæˆ–å•†ä¸šåç«¯è€Œä½¿ç”¨çš„å¼€æºå¯è§‚å¯Ÿæ€§æ•°æ®æ ¼å¼(å¦‚Jaegerï¼ŒPrometheusç­‰)çš„è¿è¡Œï¼Œæ“ä½œå’Œç»´æŠ¤ï¼›å¼€å‘äººå‘˜æ— éœ€å…³æ³¨å…·ä½“å®ç°ï¼Œä½†æ˜¯éœ€è¦äº†è§£collectorçš„é…ç½®ä¿¡æ¯ï¼Œæ–¹ä¾¿å¯¹æ•°æ®çš„æ”¶é›†ã€å¤„ç†ã€å¯¼å‡ºç›®æ ‡è¿›è¡Œè®¾ç½®
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1collectoræ¶æ„.png?w=885&h=482)
#### é…ç½®
ä»¥ä¸‹æ˜¯collectorçš„å…³é”®é…ç½®è¯´æ˜ï¼Œåˆ†åˆ«å¯¹receiversã€processesã€exportsã€serviceè¿›è¡Œäº†ä»‹ç»
- Receivers
receiverå®šä¹‰äº†æ•°æ®å¦‚ä½•è¿›å…¥OpenTelemetry Collectorã€‚å¿…é¡»é…ç½®ä¸€ä¸ªæˆ–å¤šä¸ªreceiverï¼Œé»˜è®¤ä¸ä¼šé…ç½®ä»»ä½•receivers
https://github.com/open-telemetry/opentelemetry-collector/tree/main/receiver
```yaml
eceivers:
  otlp:
    protocols:
      http:
        endpoint: "localhost:4318"
        cors:
          allowed_origins:
            - http://test.com
            # Origins can have wildcards with *, use * by itself to match any origin.
            - https://*.example.com
          allowed_headers:
            - Example-Header
          max_age: 7200
```
- Processors
Processorsè¿è¡Œåœ¨æ•°æ®çš„æ¥æ”¶å’Œå¯¼å‡ºä¹‹é—´ã€‚è™½ç„¶Processorsæ˜¯å¯é€‰çš„ï¼Œä½†æœ‰æ—¶å€™ä¼šå»ºè®®ä½¿ç”¨Processorsã€‚
ä¸€èˆ¬é€‰æ‹©æ‰¹é‡å¤„ç†å’Œå†…å­˜æ§åˆ¶çš„é€»è¾‘æ¨¡å—
https://github.com/open-telemetry/opentelemetry-collector/tree/main/processor
```yaml
processors:
  batch:
  batch/2:
    send_batch_size: 10000
    timeout: 10s
```
- Exporters
exporteræŒ‡å®šäº†å¦‚ä½•å°†æ•°æ®å‘å¾€ä¸€ä¸ªæˆ–å¤šä¸ªåç«¯/ç›®æ ‡ã€‚å¿…é¡»é…ç½®ä¸€ä¸ªæˆ–å¤šä¸ªexporterï¼Œé»˜è®¤ä¸ä¼šé…ç½®ä»»ä½•exporterã€‚
https://github.com/open-telemetry/opentelemetry-collector/tree/main/exporter
```yaml
exporters:
  otlp:
    endpoint: otelcol2:4317
    tls:
      cert_file: file.cert
      key_file: file.key
  otlp/2:
    endpoint: otelcol2:4317
    tls:
      insecure: true
```
- Services
Serviceéƒ¨åˆ†ç”¨äºé…ç½®OpenTelemetry Collectoræ ¹æ®receivers, processors, exporters, å’Œextensions sectionsçš„é…ç½®ä¼šå¯ç”¨é‚£äº›ç‰¹æ€§ã€‚serviceåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š
extensions
extensionsåŒ…å«å¯ç”¨çš„æ‰©å±•ï¼Œ
```yaml
service:
      extensions: [health_check, pprof, zpages]
```
pipelines
ä¸€ä¸ªpipelineæ˜¯ä¸€ç»„ receivers, processors, å’Œexportersçš„é›†åˆã€‚å¿…é¡»åœ¨serviceä¹‹å¤–å®šä¹‰æ¯ä¸ªreceiver/processor/exporterçš„é…ç½®ï¼Œç„¶åå°†å…¶åŒ…å«åˆ°pipelineä¸­
```yaml
receivers:
  otlp:
    protocols:
      grpc:

exporters: ${file:otlp-exporter.yaml}

service:
  extensions: [ ]
  pipelines:
    traces:
      receivers:  [ otlp ]
      processors: [  ]
      exporters:  [ otlp ]
```
#### ä½¿ç”¨
å‚è€ƒå®˜æ–¹çš„ä¾‹å­ï¼š
https://github.com/open-telemetry/opentelemetry-go/tree/main/example/otel-collector
å°†åœ¨åé¢ã€Šé“¾è·¯è¿½è¸ª(ä¸‰)ã€‹ä¸­é€šè¿‡k8sä¸­éƒ¨ç½²å¯¹åº”çš„åº”ç”¨è¯¦ç»†ä»‹ç»ï¼Œæ­¤å¤„æš‚ä¸åšè¯¦ç»†è¯´æ˜
## Traceä¸ŠæŠ¥
ç±»ä¼¼æˆ‘ä»¬åœ¨ä»‹ç»OpenCensusæ¶æ„ï¼Œotelä¹Ÿæœ‰ä¿©ç§ä½¿ç”¨æ–¹å¼ï¼›ç›´æ¥ä¸ŠæŠ¥å’Œé€šè¿‡collectorä¸ŠæŠ¥
- ç›´æ¥ä¸ŠæŠ¥
åœ¨åº”ç”¨æœåŠ¡ç›´æ¥æŒ‡å‘è¦ä¸ŠæŠ¥çš„ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆç³»ç»Ÿï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæŒ‡å‘çš„ç¬¬ä¸‰æ–¹æ˜¯å…¼å®¹otlpåè®®çš„ï¼›è¿™ç§æƒ…å†µÎ©ç±»ä¼¼äºç›´æ¥ä½¿ç”¨jaegerã€skywalkingç­‰
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1ç®€å•ä¸ŠæŠ¥.png?w=902&h=399)
- é€šè¿‡collectorä¸ŠæŠ¥
é€šè¿‡collectorç¼“å­˜ã€å¤šç«¯å‘é€åˆ°ç¬¬ä¸‰æ–¹æœåŠ¡æˆ–å¦ä¸€ä¸ªotel collector
![å›¾ç‰‡](/assets/imgs/k8s/traceing/1æœé›†ä¸ŠæŠ¥.png?w=865&h=437)


å¯¹æ¯”
ç›´æ¥ä¸ŠæŠ¥å¯ä»¥å¿«é€Ÿæ­å»ºtraceæœé›†ï¼Œä½†å¦‚æœæƒ³è°ƒæ•´æœé›†çš„æ¶æ„ï¼Œæ¯”å¦‚jaegerè°ƒæ•´åˆ°skywalkingï¼Œåˆ™éœ€è¦æ”¹åŠ¨ä»£ç ï¼›é€šè¿‡collectorä¸ŠæŠ¥ï¼Œåˆ™æ˜¯é€šè¿‡æ ‡å‡†çš„tolpè¾“å‡ºåˆ°collectorï¼Œå¦‚æœæƒ³è°ƒæ•´æ¶æ„ï¼Œåˆ™åªéœ€è¦åœ¨collectorçš„exportåšå‡ºé…ç½®ä¿®æ”¹å³å¯ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥å¤šç›®æ ‡è¾“å‡ºï¼‰
# TODO
å®Œæˆtraceç›´æ¥ä¸ŠæŠ¥é“¾è·¯è¿½è¸ª